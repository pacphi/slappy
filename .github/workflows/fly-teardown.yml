# Fly.io Teardown Workflow - Destroys the deployed application
# âš ï¸  WARNING: This is a destructive operation that cannot be undone

name: Fly Teardown

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to tear down'
        required: true
        type: choice
        options:
          - production
          - staging
      confirm_destruction:
        description: 'Type "DESTROY" to confirm deletion'
        required: true
        type: string

jobs:
  setup:
    name: Determine teardown target
    runs-on: ubuntu-latest
    outputs:
      app_name: ${{ steps.set-target.outputs.app_name }}
    steps:
      - name: Set teardown target
        id: set-target
        run: |
          if [ "${{ inputs.environment }}" == "staging" ]; then
            echo "app_name=slappy-staging" >> $GITHUB_OUTPUT
          else
            echo "app_name=slappy" >> $GITHUB_OUTPUT
          fi

  teardown:
    name: Destroy Fly.io deployment
    runs-on: ubuntu-latest
    needs: setup
    environment:
      name: ${{ inputs.environment }}
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ inputs.confirm_destruction }}" != "DESTROY" ]; then
            echo "âŒ Confirmation failed. You must type 'DESTROY' exactly to proceed."
            exit 1
          fi
          echo "âœ… Confirmation received. Proceeding with teardown..."

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Check if app exists
        id: check_app
        run: |
          if flyctl status --app ${{ needs.setup.outputs.app_name }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… App '${{ needs.setup.outputs.app_name }}' exists and will be destroyed"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  App '${{ needs.setup.outputs.app_name }}' does not exist"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        continue-on-error: true

      - name: Destroy Fly.io app
        if: steps.check_app.outputs.exists == 'true'
        run: |
          echo "ðŸ—‘ï¸  Destroying Fly.io app '${{ needs.setup.outputs.app_name }}'..."
          flyctl apps destroy ${{ needs.setup.outputs.app_name }} --yes
          echo "âœ… App destroyed successfully"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Teardown summary
        run: |
          echo "## Teardown Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** ${{ needs.setup.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Destroyed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ The deployment has been permanently removed from Fly.io" >> $GITHUB_STEP_SUMMARY
